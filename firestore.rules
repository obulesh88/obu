rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      
      function areImmutableFieldsUnchanged() {
        // These fields cannot be changed by the user after creation
        return request.resource.data.uid == resource.data.uid
          && request.resource.data.email == resource.data.email
          && request.resource.data.createdAt == resource.data.createdAt;
      }

      function isValidBalanceUpdate() {
        let balanceChange = request.resource.data.wallet.orBalance - resource.data.wallet.orBalance;
        let isNoChange = balanceChange == 0;
        let isCaptchaOrGameReward = balanceChange == 3;
        let isAdReward = balanceChange == 5;
        // Check if balance update is one of the allowed increments or no change.
        return isNoChange || isCaptchaOrGameReward || isAdReward;
      }
      
      function areOtherFieldsValid() {
        // Allow total_play_seconds to only increase or stay the same
        let validGameTime = request.resource.data.playGames.total_play_seconds >= resource.data.playGames.total_play_seconds;
        
        // Critical: Prevent the client from ever changing the INR balance.
        let inrUnchanged = request.resource.data.wallet.inrBalance == resource.data.wallet.inrBalance;
        
        return validGameTime && inrUnchanged;
      }

      allow read, create: if isOwner();

      // Allow updates if the user is the owner and the update is valid.
      allow update: if isOwner()
        && areImmutableFieldsUnchanged()
        && isValidBalanceUpdate()
        && areOtherFieldsValid();
    }
  }
}
