rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      
      function areImmutableFieldsUnchanged() {
        return request.resource.data.uid == resource.data.uid
          && request.resource.data.email == resource.data.email
          && request.resource.data.createdAt == resource.data.createdAt;
      }

      function isValidBalanceUpdate() {
        let incomingBalance = request.resource.data.wallet.orBalance;
        let existingBalance = resource.data.wallet.orBalance;
        // Balance can only be incremented by 3 (captcha/game) or 5 (ad), or stay the same (for game start).
        return incomingBalance == existingBalance + 3 
            || incomingBalance == existingBalance + 5
            || incomingBalance == existingBalance;
      }

      allow read, create: if isOwner();

      // Allow updates if the user is the owner, immutable fields are not changed,
      // and the balance update is valid. This implicitly allows other fields 
      // like timestamps and statuses to be updated in the same transaction.
      allow update: if isOwner()
        && areImmutableFieldsUnchanged()
        && isValidBalanceUpdate();
    }
  }
}
