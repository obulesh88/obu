rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      
      function areImmutableFieldsUnchanged() {
        // These fields cannot be changed after creation
        return request.resource.data.uid == resource.data.uid
          && request.resource.data.email == resource.data.email
          && request.resource.data.createdAt == resource.data.createdAt;
      }

      function isValidBalanceUpdate() {
        let incomingBalance = request.resource.data.wallet.orBalance;
        let existingBalance = resource.data.wallet.orBalance;
        
        // This is the key: compare the final value with the initial value + increment.
        // This handles the `increment()` operation correctly.
        let isCaptchaOrGameReward = incomingBalance == existingBalance + 3;
        let isAdReward = incomingBalance == existingBalance + 5;
        
        // Also allow updates where the balance doesn't change (e.g., starting a game session)
        let isUnchanged = incomingBalance == existingBalance;

        return isCaptchaOrGameReward || isAdReward || isUnchanged;
      }
      
      function isValidGameTimeUpdate() {
        // Allow total_play_seconds to be incremented or stay the same.
        // This handles both game reward claims and other updates (where it doesn't change).
        return request.resource.data.playGames.total_play_seconds >= resource.data.playGames.total_play_seconds;
      }

      allow read, create: if isOwner();

      allow update: if isOwner()
        && areImmutableFieldsUnchanged()
        && isValidBalanceUpdate()
        && isValidGameTimeUpdate()
        && request.resource.data.wallet.inrBalance == resource.data.wallet.inrBalance; // Prevent client from changing INR
    }
  }
}
