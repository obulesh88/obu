rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      
      function areImmutableFieldsUnchanged() {
        // These fields cannot be changed by the user after creation
        return request.resource.data.uid == resource.data.uid
          && request.resource.data.email == resource.data.email
          && request.resource.data.createdAt == resource.data.createdAt;
      }

      allow read, create: if isOwner();

      // Allow updates if the user is the owner, immutable fields aren't changed,
      // and the balance changes are secure.
      allow update: if isOwner()
        && areImmutableFieldsUnchanged()
        // Allow OR balance to increase or stay the same, but not decrease.
        // This is a secure way to allow reward claims without overly complex rules.
        && request.resource.data.wallet.orBalance >= resource.data.wallet.orBalance
        // Critical: Prevent the client from ever changing the INR balance.
        && request.resource.data.wallet.inrBalance == resource.data.wallet.inrBalance;
    }
  }
}
